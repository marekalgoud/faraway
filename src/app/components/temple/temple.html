<div [formGroup]="templeForm" class="flex flex-col bg-gray-50 p-3 rounded-lg shadow-md border border-gray-200 space-y-2">
  <ng-container *ngIf="templeUrl; else templePlaceholder">
    <img [src]="templeUrl"
      alt="Temple découpée"
      class="shadow-lg border-2 border-indigo-300 rounded-lg object-contain mb-2"
    >
  </ng-container>
  <ng-template #templePlaceholder>
    <div class="w-full h-40 flex items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-white text-gray-400 mb-2">
      <div class="text-center">
        <svg class="mx-auto mb-2" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="14" rx="2"></rect>
          <path d="M3 17l4-4 4 4 6-6 4 4"></path>
        </svg>
        <div class="text-sm">Aperçu indisponible</div>
      </div>
    </div>
  </ng-template>
    <ng-container *ngIf="!isEditing(); else editBlock">
      <!-- Résumé du temple -->
      <div class="space-y-3">
        <h3 class="font-bold">temple détecté</h3>
        <div [class]="`text-xs w-full p-2 rounded-lg shadow-inner ${templeBgClass()}`">
          <div class="flex items-center justify-between p-2">
            <span class="font-semibold">Valeur:</span>
            <span class="font-bold">{{ formatLabel(templeForm.get('value')?.value) }}</span>
          </div>
          @if (templeForm.get('multiplier')?.value) {
            <div class="flex items-center justify-between p-2">
              <span class="font-semibold">Multiplicateur:</span>
              <span class="font-medium">
                @let multiplicator = formatLabel(templeForm.get('multiplier')?.value);
                <img width="20" [src]="'/images/'+ multiplicator + '.png'" [alt]="multiplicator" [title]="multiplicator">
              </span>
            </div>
          }
          <div class="flex items-center justify-between p-2">
            <span class="font-semibold block mb-2">Options:</span>
            <div class="flex flex-wrap gap-2">
              @for (option of optionsArray.getRawValue(); track option) {
                <span class="flex items-center">
                  <img width="20" [src]="'/images/'+ formatLabel(option) + '.png'" [alt]="formatLabel(option)" [title]="formatLabel(option)">
                </span>
              }
            </div>
          </div>
        </div>

        <button (click)="toggleEdit()"
          class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 flex items-center justify-center space-x-2">
          Modifier
        </button>
      </div>
    </ng-container>

    <ng-template #editBlock>
      <!-- Vue d'édition (formulaire) -->
      <div class="w-full space-y-3">
        <ng-container *ngIf="templeUrl; else templePlaceholderLarge">
          <img [src]="templeUrl"
            alt="Temple découpée"
            class="shadow-lg border-2 border-indigo-300 rounded-lg object-contain block mx-auto mb-2"
          >
        </ng-container>
        <ng-template #templePlaceholderLarge>
          <div class="w-full h-48 flex items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-white text-gray-400 mb-2">
            <div class="text-center">
              <svg class="mx-auto mb-2" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="14" rx="2"></rect>
                <path d="M3 17l4-4 4 4 6-6 4 4"></path>
              </svg>
              <div class="text-sm">Aperçu indisponible</div>
            </div>
          </div>
        </ng-template>

        <div class="w-full text-xs space-y-2">
          <div>
            <label class="block font-medium text-gray-700">Couleur</label>
            <select formControlName="color" class="w-full p-1 border rounded">
              <option value="">-- Aucune --</option>
              @for (color of colorOptions; track color) {
                <option [value]="color">{{ formatLabel(color) }}</option>
              }
            </select>
          </div>

          <div>
            <label class="block font-medium text-gray-700">Valeur</label>
            <select formControlName="value" class="w-full p-1 border rounded">
              <option value="">-- Aucune --</option>
              @for (val of valueOptions; track val) {
                <option [value]="val">{{ val }}</option>
              }
            </select>
          </div>

          <div formArrayName="options" class="p-2 border rounded bg-white shadow-inner space-y-1">
            <label class="block font-medium text-gray-700 mb-1">Options</label>

            @for (control of optionsArray.controls; track control; let i = $index) {
              <div class="flex items-center space-x-1">
                <select [formControl]="control" class="w-full p-1 border rounded text-xs">
                  <option value="">-- Sélectionner --</option>
                  @for (opt of optionsList; track opt) {
                    <option [value]="opt">{{ formatLabel(opt) }}</option>
                  }
                </select>
                <button type="button" (click)="removeOption(i)" class="text-red-500 hover:text-red-700 text-lg leading-none p-1">
                  &times;
                </button>
              </div>
            }

            <button type="button" (click)="addOption()"
              class="mt-1 w-full py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition duration-100">
              + Ajouter une Option
            </button>
          </div>

          <div>
            <label class="block font-medium text-gray-700">Multiplicateur</label>
            <select formControlName="multiplier" class="w-full p-1 border rounded">
              <option value="">-- Aucun --</option>
              @for (mult of multiplierOptions; track mult) {
                <option [value]="mult">{{ mult }}</option>
              }
            </select>
          </div>

        </div>

        <button (click)="toggleEdit()"
          class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 flex items-center justify-center space-x-2">
          Retour au Résumé
        </button>
      </div>
    </ng-template>