<div class="p-6 bg-gray-100 min-h-screen">
  <h1 class="text-3xl font-bold text-center text-indigo-800 mb-6">Détecteur de Scène & Analyse de Cartes</h1>

  <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-2xl">

    <!-- ... (Contrôles d'Upload et Chargement inchangés) ... -->
    <div class="flex flex-col sm:flex-row gap-4 mb-6 items-center">
      <input
        type="file"
        (change)="onFileSelected($event)"
        accept="image/*"
        class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
        [disabled]="isLoading()"
        >
        <button
          (click)="detectImage()"
          [disabled]="!imageSelected() || isLoading()"
          class="w-full sm:w-auto px-6 py-2 rounded-lg text-white font-semibold transition duration-150"
          [ngClass]="{'bg-indigo-600 hover:bg-indigo-700': imageSelected(), 'bg-gray-400 cursor-not-allowed': !imageSelected()}"
          >
          Détecter Objets
        </button>
        <button
          type="button"
          (click)="rotateImage()"
          [disabled]="!imageSelected()"
          class="w-full sm:w-auto px-6 py-2 rounded-lg text-white font-semibold transition duration-150"
          [ngClass]="{'bg-amber-600 hover:bg-amber-700': imageSelected(), 'bg-gray-400 cursor-not-allowed': !imageSelected()}"
          title="Rotate image 90° clockwise"
          >
          ↻ Rotation
        </button>
      </div>

      @if (isLoading()) {
        <div
          class="flex flex-col items-center justify-center bg-white bg-opacity-80 py-4">
          <div class="loader text-indigo-700 text-xl mb-4"></div>
          <p class="text-indigo-700 text-sm font-medium">{{ loadingMessage() }}</p>
        </div>
      }

      @if (errorMessage()) {
        <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
          <strong>Erreur:</strong> {{ errorMessage() }}
        </div>
      }

      @if (warningMessage()) {
        <div class="mb-4 p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg">
          <strong>Attention:</strong> {{ warningMessage() }}
        </div>
      }

      <div class="relative w-full overflow-hidden border-4 border-dashed border-gray-300 rounded-lg bg-gray-50 mb-8" style="min-height:8rem;">
        <img #imageElement
          [src]="imageUrl()"
          alt="Image chargée pour détection"
          (load)="onImageLoaded()"
          class="hidden"
          >
          <canvas #canvas
            class="preview-canvas w-full h-auto block"
            [style.opacity]="imageUrl() ? '1' : '0'"
            ></canvas>
            <div class="placeholder absolute inset-0 flex items-center justify-center text-gray-500"
                 [style.opacity]="imageUrl() ? '0' : '1'">
              Veuillez sélectionner une image (JPG ou PNG).
            </div>
      </div>
        <!-- FORMULAIRE PRINCIPAL -->
        <form [formGroup]="detectorForm">
          @if (cardsFormArray.controls.length > 0) {
            <div class="mt-4">
              <h2 class="text-xl font-semibold text-indigo-800 mb-4">Cartes</h2>
              <div formArrayName="cards">
                <swiper-container
                navigation="false"
                pagination="true"
                [breakpoints]="{
                  '768': {
                    slidesPerView: 3,
                  },
                  '1024': {
                    slidesPerView: 5,
                  }
                }">
                  @for (cardCtrl of cardsFormArray.controls; track cardCtrl; let i = $index) {
                    <swiper-slide>
                    <div [formGroupName]="i" class="my-8 mx-2">
                      <app-card
                        [cardForm]="ctrlAsFormGroup(cardCtrl)"
                        [cardUrl]="getCroppedCardUrl(i)"
                        [cardIndex]="i"
                        (deleteCard)="deleteCard($event)"
                        class="w-full"
                      ></app-card>
                    </div>
                    </swiper-slide>
                  }
                  </swiper-container>
              </div>
            </div>
          }

          @if (templesFormArray.controls.length > 0) {
            <div class="mt-4">
              <h2 class="text-xl font-semibold text-indigo-800 mb-4">Temples</h2>
              <div formArrayName="temples">
                <swiper-container
                navigation="false"
                pagination="true"
                [breakpoints]="{
                  '768': {
                    slidesPerView: 3,
                  },
                  '1024': {
                    slidesPerView: 5,
                  }
                }">
                @for (templeCtrl of templesFormArray.controls; track templeCtrl; let i = $index) {
                  <swiper-slide>
                  <div [formGroupName]="i" class="my-8 mx-2">
                    <app-temple
                      [templeForm]="ctrlAsFormGroup(templeCtrl)"
                      [templeUrl]="getCroppedTempleUrl(i)"
                      [templeIndex]="i"
                      (deleteTemple)="deleteTemple($event)"
                      class="w-full"
                    ></app-temple>
                  </div>
                  </swiper-slide>
                }
                </swiper-container>
              </div>
            </div>
          }

        </form>

        <!-- NOUVEAU: Section de Calcul de Score -->
        @if (cardsFormArray.controls.length > 0 || templesFormArray.controls.length > 0) {
          <div class="mt-12 pt-6 border-t">
            <button
              (click)="calculateScore()"
              class="w-full px-8 py-3 rounded-lg text-white font-bold text-lg transition duration-150 bg-green-600 hover:bg-green-700"
              >
              Calculer le Score
            </button>
            <!-- Zone d'affichage des résultats -->
            @if (calculationDetails().length > 0) {
              <div class="mt-6 p-4 bg-gray-800 text-gray-100 rounded-lg shadow-inner">
                <h3 class="text-lg font-semibold text-green-300 mb-3">Détail du Calcul</h3>
                <div class="font-mono text-sm whitespace-pre-wrap">
                  @for (detail of calculationDetails(); track detail) {
                    <div>{{ detail }}</div>
                  }
                </div>
                <h2 class="text-2xl font-bold text-white text-center mt-4 border-t border-gray-600 pt-4">
                  Score Total: {{ totalScore() }}
                </h2>
              </div>
            }
          </div>
        }

      </div>
    </div>

