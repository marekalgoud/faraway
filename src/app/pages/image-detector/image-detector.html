<div class="p-6 bg-gray-100 min-h-screen">
  <h1 class="text-3xl font-bold text-center text-indigo-800 mb-6">DÃ©tecteur de ScÃ¨ne & Analyse de Cartes</h1>

  <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-2xl">

    <!-- ContrÃ´les d'Upload et de Chargement -->
    <div class="flex flex-col sm:flex-row gap-4 mb-6 items-center">
      <input
        type="file"
        (change)="onFileSelected($event)"
        accept="image/*"
        class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
        [disabled]="isLoading()"
      >
      <button
        (click)="detectImage()"
        [disabled]="!imageSelected() || isLoading()"
        class="w-full sm:w-auto px-6 py-2 rounded-lg text-white font-semibold transition duration-150"
        [ngClass]="{'bg-indigo-600 hover:bg-indigo-700': imageSelected(), 'bg-gray-400 cursor-not-allowed': !imageSelected()}"
      >
        DÃ©tecter Objets
      </button>
    </div>

    <!-- Indicateur de chargement -->
    <div *ngIf="isLoading()"
         class="loading-overlay fixed inset-0 z-50 flex flex-col items-center justify-center bg-white bg-opacity-80">
      <div class="loader text-indigo-700 text-2xl mb-4" style="border: 8px solid #f3f3f3; border-top: 8px solid #4f46e5; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;"></div>
      <p class="text-indigo-700 text-xl font-medium">{{ loadingMessage() }}</p>
    </div>

    <!-- Zone d'affichage de l'image et des dÃ©tections -->
    <div class="relative w-full overflow-hidden border-4 border-dashed border-gray-300 rounded-lg bg-gray-50 mb-8">
      <img #imageElement
           [src]="imageUrl()"
           alt="Image chargÃ©e pour dÃ©tection"
           (load)="onImageLoaded()"
           class="w-full h-auto object-contain"
           [ngClass]="{'hidden': !imageUrl()}"
      >
      <canvas #canvas
              class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
      <div *ngIf="!imageUrl()" class="flex items-center justify-center h-64 text-gray-500">
        Veuillez sÃ©lectionner une image (JPG ou PNG).
      </div>
    </div>

    <!-- FORMULAIRE PRINCIPAL -->
    <form [formGroup]="detectorForm">

      <!-- Section ANALYSE DE CARTES -->
      <div *ngIf="cardsFormArray.controls.length > 0" class="mt-8">
        <h2 class="text-xl font-semibold text-indigo-800 mb-4">ğŸƒ Cartes (Gauche Ã  Droite) & Analyse des Ã‰lÃ©ments</h2>

        <div formArrayName="cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          <div *ngFor="let cardCtrl of cardsFormArray.controls; let i = index" [formGroupName]="i">
            <app-card
              [cardForm]="ctrlAsFormGroup(cardCtrl)"
              [cardUrl]="croppedCards()[i].url"
              class="w-full"
            ></app-card>
          </div>
        </div>
      </div>

      <!-- NOUVEAU: Section ANALYSE DES TEMPLES -->
      <div *ngIf="templesFormArray.controls.length > 0" class="mt-8">
        <h2 class="text-xl font-semibold text-indigo-800 mb-4">ğŸ›ï¸ Temples & Analyse</h2>

        <div formArrayName="temples" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          <div *ngFor="let templeCtrl of templesFormArray.controls; let i = index" [formGroupName]="i">
            <!-- Utilisation du nouveau composant app-temple -->
            <app-temple
              [templeForm]="ctrlAsFormGroup(templeCtrl)"
              [templeUrl]="croppedTemples()[i].url"
              class="w-full"
            ></app-temple>
          </div>
        </div>
      </div>

    </form> <!-- Fin du formulaire principal -->

  </div>
</div>
